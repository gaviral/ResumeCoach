# GitHub Actions CI/CD pipeline for ResumeCoach
# ------------------------------------------------
# This workflow validates every PR and deploys to the "prod" AWS account
# whenever changes land on the `main` branch.
#
# Required GitHub secrets (Repository → Settings → Secrets and variables → Actions):
#   AWS_ACCESS_KEY_ID           - AWS access key for authentication
#   AWS_SECRET_ACCESS_KEY       - AWS secret key for authentication
#   AWS_REGION                  – defaults to us‑west‑2 for this project
#
name: CI & CD

on:
  # Validate pull requests to main
  pull_request:
    branches: [main]
  # Deploy when main is updated
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  # ────────────────────────────────────────────────────────────────
  build-test-deploy:
    name: Lint / Build / Test / Deploy
    runs-on: ubuntu-latest
    # Add concurrency to prevent multiple deploys running at once
    concurrency:
      group: production-deploy
      cancel-in-progress: false

    steps:
      # 1️⃣  Check out code
      - uses: actions/checkout@v4

      # 2️⃣  Front‑end tasks (Node 20)
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: package-lock.json # ← root lock-file

      # 🔹 NEW: install root + workspace deps
      - name: Install deps (root + workspace)
        run: npm ci

      - name: Lint front-end
        run: npm run -w frontend lint --if-present

      - name: Build front-end
        run: npm run -w frontend build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      # 3️⃣  Back‑end tasks (Python 3.11)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install back-end deps
        run: pip install -r backend/requirements.txt

      - name: Run back-end tests (placeholder)
        run: |
          if [ -d tests ]; then
            python -m pytest -q
          else
            echo "No tests yet – skipping."
          fi

      # 4️⃣  Configure AWS credentials using access keys
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-west-2' }}

      # 5️⃣  Install CDK & infra deps
      - name: Install CDK & infra deps
        working-directory: infrastructure
        run: npm ci

      # 6️⃣  CDK synth to ensure infra compiles
      - name: CDK synth
        working-directory: infrastructure
        run: npx cdk synth

      # 7️⃣  Deploy only if on main branch and not a PR
      - name: CDK deploy (no approval)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: infrastructure
        run: npx cdk deploy --require-approval never
